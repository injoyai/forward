<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>端口转发管理</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --secondary-color: #6c757d;
            --success-color: #2ec4b6;
            --warning-color: #ff9f1c;
            --danger-color: #e71d36;
            --light-bg: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #2b2d42;
            --text-secondary: #8d99ae;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.2s ease-in-out;
        }

        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
        }

        /* 主卡片样式 */
        .main-card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background: var(--card-bg);
            overflow: hidden;
        }

        .card-header-custom {
            background: #fff;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title i {
            color: var(--primary-color);
        }

        .card-body {
            padding: 2rem;
        }

        /* 列表项样式 */
        .list-group {
            gap: 12px;
        }

        .forward-item {
            border: 1px solid #edf2f7;
            border-radius: var(--border-radius) !important;
            background: #fff;
            transition: var(--transition);
            margin-bottom: 0;
            padding: 1.25rem;
        }

        .forward-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
            border-color: #e2e8f0;
            z-index: 1;
        }

        .forward-info-grid {
            display: grid;
            grid-template-columns: 1.2fr 2fr minmax(0, 4fr) auto;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .forward-info-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }
            .forward-actions {
                justify-content: flex-start;
                margin-top: 0.5rem;
            }
        }

        .forward-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }

        .forward-name span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .forward-details {
            color: var(--text-secondary);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }
        
        .forward-details i {
            color: #cbd5e1;
            font-size: 0.8rem;
        }
        
        .port-badge {
            background: #e0e7ff;
            color: #4361ee;
            padding: 2px 8px;
            border-radius: 6px;
            font-family: monospace;
            font-weight: 600;
            font-size: 0.9em;
        }

        /* 按钮样式 */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            border: none;
        }
        
        .btn-sm {
            padding: 0.35rem 0.8rem;
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            box-shadow: 0 4px 6px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(67, 97, 238, 0.4);
        }

        .btn-secondary {
            background-color: #f1f5f9;
            color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: #e2e8f0;
            color: #475569;
        }

        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #25a296; }

        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-warning:hover { background-color: #e0890f; color: white; }

        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c9182b; }
        
        .btn-info { background-color: #4cc9f0; color: white; }
        .btn-info:hover { background-color: #3ab0d6; color: white; }
        
        .action-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
        }

        /* 表单控件 */
        .form-control {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            padding: 0.75rem 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
            border-color: var(--primary-color);
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-main);
            margin-bottom: 0.5rem;
        }

        /* 状态标签 */
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .status-active {
            background-color: rgba(46, 196, 182, 0.15);
            color: var(--success-color);
        }

        .status-stopped {
            background-color: rgba(108, 117, 125, 0.15);
            color: var(--secondary-color);
        }

        .status-error {
            background-color: rgba(231, 29, 54, 0.15);
            color: var(--danger-color);
        }

        /* 模态框 */
        .modal {
            backdrop-filter: blur(5px);
        }

        .modal-content {
            border: none;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .modal-header {
            border-bottom: 1px solid #f1f5f9;
            padding: 1.5rem;
        }
        
        .modal-title {
            font-weight: 700;
            color: var(--text-main);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid #f1f5f9;
            padding: 1rem 1.5rem;
        }

        /* 通知 */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 9999;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show { transform: translateX(0); }
        .notification.success { background: linear-gradient(135deg, #2ec4b6, #20a094); }
        .notification.error { background: linear-gradient(135deg, #e71d36, #c9182b); }
        .notification.warning { background: linear-gradient(135deg, #ff9f1c, #e0890f); }
        .notification.info { background: linear-gradient(135deg, #4cc9f0, #3ab0d6); }

        /* 错误提示 */
        .status-container {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            min-width: 0;
        }

        .error-message {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
            color: var(--danger-color);
            font-size: 0.85rem;
            flex: 1;
            min-width: 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #cbd5e1;
        }
    </style>
</head>
<body>
<div class="container py-5">
    <div id="forwardList" class="main-card">
        <div class="card-header-custom">
            <h2 class="page-title"><i class="fas fa-network-wired"></i> 端口转发管理</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="showAddForm()">
                    <i class="fas fa-plus"></i> 新建规则
                </button>
                <button class="btn btn-secondary" onclick="refresh()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="list-group">
                <!-- 列表将通过JS注入 -->
            </div>
        </div>
    </div>

    <!-- 添加模态框 -->
    <div id="addModal" class="modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加转发规则</h5>
                    <button type="button" class="btn-close" onclick="hideAddForm()"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">名称</label>
                        <input type="text" class="form-control" id="name" placeholder="例如：Web服务器">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">监听端口 (Local)</label>
                        <input type="text" class="form-control" id="port" placeholder="例如：8080">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">转发地址 (Remote)</label>
                        <input type="text" class="form-control" id="address" placeholder="例如：192.168.1.100:80">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideAddForm()">取消</button>
                    <button class="btn btn-primary" onclick="submitAdd()">确认添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改转发规则</h5>
                    <button type="button" class="btn-close" onclick="hideEditForm()"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">名称</label>
                        <input type="text" class="form-control" id="editName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">监听端口 (Local)</label>
                        <input type="text" class="form-control" id="editPort">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">转发地址 (Remote)</label>
                        <input type="text" class="form-control" id="editAddress">
                    </div>
                    <input type="hidden" id="editId">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="hideEditForm()">取消</button>
                    <button class="btn btn-primary" onclick="submitEdit()">保存修改</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
</div>

<script>
    function loading(forwards) {
        console.log(forwards)
        const listGroup = document.querySelector('.list-group');
        listGroup.innerHTML = '';

        if (!forwards || forwards.length === 0) {
            listGroup.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>暂无转发规则，请点击右上角添加</p>
                </div>
            `;
            return;
        }

        forwards.forEach(forward => {
            const item = document.createElement('div');
            item.className = 'list-group-item forward-item';

            let statusBadge = '';
            if (forward.enable) {
                if (forward.running) {
                    statusBadge = `<span class="status-badge status-active">运行中</span>`;
                } else {
                    statusBadge = `
                        <span class="status-badge status-error">错误</span>
                        <span class="error-message" title="${forward.error || '未知错误'}">
                             <i class="fas fa-exclamation-circle"></i> ${forward.error || '未知错误'}
                        </span>
                    `;
                }
            } else {
                statusBadge = `<span class="status-badge status-stopped">已停止</span>`;
            }

            item.innerHTML = `
                <div class="forward-info-grid">
                    <div class="forward-name" title="${forward.name || '未命名'}">
                        <i class="fas fa-cube text-muted small" style="flex-shrink: 0;"></i> <span>${forward.name || '未命名'}</span>
                    </div>
                    
                    <div class="forward-details">
                        <span class="port-badge">${forward.port}</span>
                        <i class="fas fa-arrow-right"></i>
                        <span class="text-truncate" title="${forward.address}">${forward.address}</span>
                    </div>

                    <div class="status-container">
                        ${statusBadge}
                    </div>
                    
                    <div class="forward-actions d-flex gap-2 justify-content-end">
                        ${forward.enable ?
                            `<button class="btn btn-warning btn-sm" onclick="stopForward('${forward.id}')" title="停止">
                                <i class="fas fa-stop"></i> <span class="d-none d-md-inline">停止</span>
                            </button>` :
                            `<button class="btn btn-success btn-sm" onclick="startForward('${forward.id}')" title="启动">
                                <i class="fas fa-play"></i> <span class="d-none d-md-inline">启动</span>
                            </button>`
                        }
                        <button class="btn btn-info btn-sm" onclick="showEditForm('${forward.id}', '${forward.name}', '${forward.port}', '${forward.address}')" title="修改">
                            <i class="fas fa-edit"></i> <span class="d-none d-md-inline">修改</span>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteForward('${forward.id}')" title="删除">
                            <i class="fas fa-trash"></i> <span class="d-none d-md-inline">删除</span>
                        </button>
                    </div>
                </div>
            `;
            listGroup.appendChild(item);
        });
    }

    function clearInputs() {
        document.getElementById('name').value = '';
        document.getElementById('port').value = '';
        document.getElementById('address').value = '';
    }

    document.addEventListener('DOMContentLoaded', loadForwards);

    function showEditForm(id, name, port, address) {
        document.getElementById('editId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editPort').value = port;
        document.getElementById('editAddress').value = address;
        document.getElementById('editModal').style.display = 'block';
    }

    function hideEditForm() {
        document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editModal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideEditForm();
        }
    });

    function showAddForm() {
        clearInputs();
        document.getElementById('addModal').style.display = 'block';
    }

    function hideAddForm() {
        document.getElementById('addModal').style.display = 'none';
    }

    function submitAdd() {
        const name = document.getElementById('name').value;
        const port = document.getElementById('port').value;
        const address = document.getElementById('address').value;
        addRule(name, port, address).then(() => {
            hideAddForm();
            loadForwards();
            notice('添加成功', 'success');
        }).catch(error => {
            notice(`添加失败: ${error.message}`, 'error');
        });
    }

    function submitEdit() {
        const id = document.getElementById('editId').value;
        const name = document.getElementById('editName').value;
        const port = document.getElementById('editPort').value;
        const address = document.getElementById('editAddress').value;
        editRule(id, name, port, address).then(() => {
            hideEditForm();
            loadForwards();
            notice('修改成功', 'success');
        }).catch(error => {
            notice(`修改失败: ${error.message}`, 'error');
        });
    }

    document.getElementById('addModal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideAddForm();
        }
    });

    function refresh() {
        getForwards().then(data => {
            loading(data);
            notice('刷新成功', 'success');
        }).catch(error => {
            notice(`刷新失败: ${error.message}`, 'error');
        });
    }

    function deleteForward(id) {
        if(!confirm('确定要删除这条规则吗？')) return;
        
        deleteRule(id).then(() => {
            loadForwards();
            notice('删除成功', 'success');
        }).catch(error => {
            notice(`删除失败: ${error.message}`, 'error');
        });
    }

    function startForward(id) {
        toggleRuleStatus(id, true).then(() => {
            loadForwards();
            notice('启动成功', 'success');
        }).catch(error => {
            notice(`启动失败: ${error.message}`, 'error');
        });
    }

    function stopForward(id) {
        toggleRuleStatus(id, false).then(() => {
            loadForwards();
            notice('停止成功', 'success');
        }).catch(error => {
            notice(`停止失败: ${error.message}`, 'error');
        });
    }

    function notice(message, type = 'info') {
        const notification = document.getElementById('notification');
        
        // Icon mapping
        let icon = 'info-circle';
        if (type === 'success') icon = 'check-circle';
        if (type === 'error') icon = 'exclamation-circle';
        if (type === 'warning') icon = 'exclamation-triangle';
        
        notification.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
        notification.className = `notification ${type}`;

        setTimeout(() => {
            notification.classList.add('show');
        }, 10);

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // 获取所有转发规则
    function loadForwards() {
        getForwards()
            .then(data => {
                loading(data);
            })
            .catch(error => {
                notice(`获取失败: ${error.message}`, 'error');
            });
    }

    // API Calls
    async function getForwards() {
        const response = await fetch('/api/forward/all');
        const data = await response.json();
        check(data)
        return data.data
    }

    async function addRule(name, port, address) {
        const response = await fetch('/api/forward', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                'name': name,
                'port': parseInt(port),
                'address': address
            })
        });
        const data = await response.json();
        check(data)
    };

    async function editRule(id, name, port, address) {
        const response = await fetch('/api/forward', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                'id': parseInt(id),
                'name': name,
                'port': parseInt(port),
                'address': address
            })
        });
        const data = await response.json();
        check(data)
    };

    async function deleteRule(id) {
        const response = await fetch('/api/forward', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({id})
        });
        const data = await response.json();
        check(data)
    }

    async function toggleRuleStatus(id, enable) {
        const endpoint = enable ? '/api/forward/enable' : '/api/forward/disable';
        try {
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({id})
            });
            const data = await response.json();
            console.log(data.message);
        } catch (error) {
            console.error('切换规则状态出错:', error);
            throw error;
        }
    }

    function check(data) {
        if (data.code !== 200) {
            throw new Error(data.msg);
        }
    }
</script>
</body>
</html>